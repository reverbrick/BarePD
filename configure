#!/bin/bash
#
# configure - BarePD configuration script
#
# Usage: ./configure [options]
#

set -e

# Default values
RASPPI=4
AARCH=64
PREFIX=""
PREFIX64="aarch64-none-elf-"

# Parse arguments
while [[ $# -gt 0 ]]; do
    case $1 in
        -r|--rasppi)
            RASPPI="$2"
            shift 2
            ;;
        -a|--aarch)
            AARCH="$2"
            shift 2
            ;;
        -p|--prefix)
            if [[ "$AARCH" == "64" ]]; then
                PREFIX64="$2"
            else
                PREFIX="$2"
            fi
            shift 2
            ;;
        -h|--help)
            echo "BarePD configuration script"
            echo ""
            echo "Usage: $0 [options]"
            echo ""
            echo "Options:"
            echo "  -r, --rasppi N    Raspberry Pi version (1-5, default: 4)"
            echo "  -a, --aarch N     Architecture (32 or 64, default: 64)"
            echo "  -p, --prefix STR  Toolchain prefix (e.g., aarch64-none-elf-)"
            echo "  -h, --help        Show this help"
            echo ""
            echo "Examples:"
            echo "  $0 -r 4                           # Pi 4, 64-bit, auto toolchain"
            echo "  $0 -r 3 -a 64 -p aarch64-linux-gnu-"
            echo "  $0 -r 2 -a 32 -p arm-none-eabi-"
            exit 0
            ;;
        *)
            echo "Unknown option: $1"
            exit 1
            ;;
    esac
done

# Set architecture-specific defaults
if [[ "$AARCH" == "64" ]]; then
    if [[ -z "$PREFIX64" ]]; then
        PREFIX64="aarch64-none-elf-"
    fi
    TOOLCHAIN_PREFIX="$PREFIX64"
else
    if [[ -z "$PREFIX" ]]; then
        PREFIX="arm-none-eabi-"
    fi
    TOOLCHAIN_PREFIX="$PREFIX"
fi

# Determine kernel name
case $RASPPI in
    1) KERNEL="kernel" ;;
    2) KERNEL="kernel7" ;;
    3)
        if [[ "$AARCH" == "64" ]]; then
            KERNEL="kernel8"
        else
            KERNEL="kernel8-32"
        fi
        ;;
    4)
        if [[ "$AARCH" == "64" ]]; then
            KERNEL="kernel8-rpi4"
        else
            KERNEL="kernel7l"
        fi
        ;;
    5) KERNEL="kernel_2712" ;;
esac

echo "Configuring BarePD..."
echo "  Raspberry Pi: $RASPPI"
echo "  Architecture: $AARCH-bit"
echo "  Toolchain: $TOOLCHAIN_PREFIX"
echo "  Kernel: $KERNEL.img"

# Generate Config.mk
cat > Config.mk << EOF
#
# Config.mk - Generated by configure
#
# BarePD Circle configuration
#

RASPPI = $RASPPI
AARCH = $AARCH
EOF

if [[ "$AARCH" == "64" ]]; then
    echo "PREFIX64 = $PREFIX64" >> Config.mk
else
    echo "PREFIX = $PREFIX" >> Config.mk
fi

cat >> Config.mk << EOF

# Enable standard library support
STDLIB_SUPPORT = 3

# Optimization
OPTIMIZE = -O2
EOF

# Configure Circle
echo ""
echo "Configuring Circle..."
cd circle
if [[ "$AARCH" == "64" ]]; then
    ./configure -r $RASPPI -p "$PREFIX64"
else
    ./configure -r $RASPPI -p "$PREFIX"
fi
cd ..

echo ""
echo "Configuration complete!"
echo ""
echo "Next steps:"
echo "  1. Build Circle:    cd circle && ./makeall clean && ./makeall"
echo "  2. Build addons:    cd circle/addon/SDCard && make && cd ../fatfs && make"
echo "  3. Build BarePD:    cd src && make"
echo "  4. Copy to SD card: $KERNEL.img + firmware files"

