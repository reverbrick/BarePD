name: Build BarePD

on:
  push:
    branches: [ main ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-rpi3b:
    name: Build for Raspberry Pi 3B/3B+
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive
    
    - name: Download ARM GNU Toolchain
      run: |
        wget -q https://developer.arm.com/-/media/Files/downloads/gnu/13.2.rel1/binrel/arm-gnu-toolchain-13.2.rel1-x86_64-arm-none-eabi.tar.xz
        tar -xf arm-gnu-toolchain-13.2.rel1-x86_64-arm-none-eabi.tar.xz
        echo "$PWD/arm-gnu-toolchain-13.2.Rel1-x86_64-arm-none-eabi/bin" >> $GITHUB_PATH
    
    - name: Configure Circle for RPi 3B
      working-directory: circle
      run: |
        cat > Config.mk << EOF
        PREFIX = arm-none-eabi-
        AARCH = 32
        RASPPI = 3
        STDLIB_SUPPORT = 3
        EOF
        cat Config.mk
    
    - name: Build Circle libraries
      working-directory: circle
      run: |
        ./makeall
        cd addon/SDCard && make
    
    - name: Build BarePD kernel
      working-directory: src
      run: make
    
    - name: Show build result
      run: |
        ls -la src/kernel8-32.img
        file src/kernel8-32.img
    
    - name: Upload kernel artifact
      uses: actions/upload-artifact@v4
      with:
        name: barepd-rpi3b-kernel
        path: src/kernel8-32.img
        retention-days: 30

  build-zerow:
    name: Build for Raspberry Pi Zero W
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive
    
    - name: Download ARM GNU Toolchain
      run: |
        wget -q https://developer.arm.com/-/media/Files/downloads/gnu/13.2.rel1/binrel/arm-gnu-toolchain-13.2.rel1-x86_64-arm-none-eabi.tar.xz
        tar -xf arm-gnu-toolchain-13.2.rel1-x86_64-arm-none-eabi.tar.xz
        echo "$PWD/arm-gnu-toolchain-13.2.Rel1-x86_64-arm-none-eabi/bin" >> $GITHUB_PATH
    
    - name: Configure Circle for RPi Zero W
      working-directory: circle
      run: |
        cat > Config.mk << EOF
        PREFIX = arm-none-eabi-
        AARCH = 32
        RASPPI = 1
        STDLIB_SUPPORT = 3
        EOF
        cat Config.mk
    
    - name: Build Circle libraries
      working-directory: circle
      run: |
        ./makeall
        cd addon/SDCard && make
    
    - name: Build BarePD kernel
      working-directory: src
      run: make
    
    - name: Show build result
      run: |
        ls -la src/kernel.img
        file src/kernel.img
    
    - name: Upload kernel artifact
      uses: actions/upload-artifact@v4
      with:
        name: barepd-zerow-kernel
        path: src/kernel.img
        retention-days: 30

  release:
    name: Create Release
    needs: [build-rpi3b, build-zerow]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    
    permissions:
      contents: write
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Download RPi 3B kernel
      uses: actions/download-artifact@v4
      with:
        name: barepd-rpi3b-kernel
        path: release/rpi3b
    
    - name: Download Zero W kernel
      uses: actions/download-artifact@v4
      with:
        name: barepd-zerow-kernel
        path: release/zerow
    
    - name: Download Raspberry Pi firmware
      run: |
        # Download required boot files from official RPi firmware repo
        mkdir -p firmware
        cd firmware
        
        # Essential boot files for all Pi models
        wget -q https://github.com/raspberrypi/firmware/raw/master/boot/bootcode.bin
        wget -q https://github.com/raspberrypi/firmware/raw/master/boot/start.elf
        wget -q https://github.com/raspberrypi/firmware/raw/master/boot/fixup.dat
        
        # Additional files for better compatibility
        wget -q https://github.com/raspberrypi/firmware/raw/master/boot/start_x.elf
        wget -q https://github.com/raspberrypi/firmware/raw/master/boot/fixup_x.dat
        wget -q https://github.com/raspberrypi/firmware/raw/master/boot/start_cd.elf
        wget -q https://github.com/raspberrypi/firmware/raw/master/boot/fixup_cd.dat
        
        # BCM2710 device tree for RPi 3B
        wget -q https://github.com/raspberrypi/firmware/raw/master/boot/bcm2710-rpi-3-b.dtb
        wget -q https://github.com/raspberrypi/firmware/raw/master/boot/bcm2710-rpi-3-b-plus.dtb
        
        # BCM2708 device tree for RPi Zero W
        wget -q https://github.com/raspberrypi/firmware/raw/master/boot/bcm2708-rpi-zero-w.dtb
        
        ls -la
    
    - name: Install tools for image creation
      run: |
        sudo apt-get update
        sudo apt-get install -y mtools dosfstools parted
    
    - name: Create example patch
      run: |
        mkdir -p patches
        cat > patches/main.pd << 'EOF'
        #N canvas 0 0 600 400 10;
        #X obj 50 50 osc~ 440;
        #X obj 50 100 *~ 0.1;
        #X obj 50 150 dac~;
        #X text 50 20 BarePD - Simple 440Hz test tone;
        #X text 200 50 Replace this file with your own patch!;
        #X connect 0 0 1 0;
        #X connect 1 0 2 0;
        #X connect 1 0 2 1;
        EOF
    
    - name: Create RPi 3B SD card image
      run: |
        IMG=BarePD-${{ github.ref_name }}-rpi3b.img
        
        # Create 64MB image
        dd if=/dev/zero of=$IMG bs=1M count=64
        
        # Create MBR partition table with one FAT32 partition
        # Partition starts at sector 2048 (1MB offset) for alignment
        parted -s $IMG mklabel msdos
        parted -s $IMG mkpart primary fat32 1MiB 100%
        parted -s $IMG set 1 boot on
        parted -s $IMG set 1 lba on
        
        # Show partition table
        parted -s $IMG print
        
        # Setup loop device to access the partition
        LOOP=$(sudo losetup -f --show -P $IMG)
        echo "Loop device: $LOOP"
        
        # Wait for partition to appear
        sleep 1
        
        # Format the partition as FAT32
        sudo mkfs.vfat -F 32 -n BAREPD ${LOOP}p1
        
        # Mount and copy files
        sudo mkdir -p /mnt/sdcard
        sudo mount ${LOOP}p1 /mnt/sdcard
        
        # Copy firmware files
        sudo cp firmware/bootcode.bin /mnt/sdcard/
        sudo cp firmware/start.elf /mnt/sdcard/
        sudo cp firmware/fixup.dat /mnt/sdcard/
        sudo cp firmware/start_x.elf /mnt/sdcard/
        sudo cp firmware/fixup_x.dat /mnt/sdcard/
        sudo cp firmware/bcm2710-rpi-3-b.dtb /mnt/sdcard/
        sudo cp firmware/bcm2710-rpi-3-b-plus.dtb /mnt/sdcard/
        
        # Copy BarePD kernel
        sudo cp release/rpi3b/kernel8-32.img /mnt/sdcard/
        
        # Copy config files
        sudo cp sdcard/config.txt /mnt/sdcard/
        sudo cp sdcard/cmdline.txt /mnt/sdcard/
        
        # Copy example patch
        sudo cp patches/main.pd /mnt/sdcard/
        
        # Show contents
        ls -la /mnt/sdcard/
        
        # Unmount and cleanup
        sudo umount /mnt/sdcard
        sudo losetup -d $LOOP
        
        # Compress the image
        zip BarePD-${{ github.ref_name }}-rpi3b-sdcard.zip $IMG
    
    - name: Create RPi Zero W SD card image
      run: |
        IMG=BarePD-${{ github.ref_name }}-zerow.img
        
        # Create 64MB image
        dd if=/dev/zero of=$IMG bs=1M count=64
        
        # Create MBR partition table with one FAT32 partition
        parted -s $IMG mklabel msdos
        parted -s $IMG mkpart primary fat32 1MiB 100%
        parted -s $IMG set 1 boot on
        parted -s $IMG set 1 lba on
        
        # Show partition table
        parted -s $IMG print
        
        # Setup loop device
        LOOP=$(sudo losetup -f --show -P $IMG)
        echo "Loop device: $LOOP"
        sleep 1
        
        # Format the partition as FAT32
        sudo mkfs.vfat -F 32 -n BAREPD ${LOOP}p1
        
        # Mount and copy files
        sudo mkdir -p /mnt/sdcard
        sudo mount ${LOOP}p1 /mnt/sdcard
        
        # Copy firmware files
        sudo cp firmware/bootcode.bin /mnt/sdcard/
        sudo cp firmware/start.elf /mnt/sdcard/
        sudo cp firmware/fixup.dat /mnt/sdcard/
        sudo cp firmware/start_cd.elf /mnt/sdcard/
        sudo cp firmware/fixup_cd.dat /mnt/sdcard/
        sudo cp firmware/bcm2708-rpi-zero-w.dtb /mnt/sdcard/
        
        # Copy BarePD kernel
        sudo cp release/zerow/kernel.img /mnt/sdcard/
        
        # Copy config files (use zerow config)
        sudo cp sdcard/config-zerow.txt /mnt/sdcard/config.txt
        sudo cp sdcard/cmdline.txt /mnt/sdcard/
        
        # Copy example patch
        sudo cp patches/main.pd /mnt/sdcard/
        
        # Show contents
        ls -la /mnt/sdcard/
        
        # Unmount and cleanup
        sudo umount /mnt/sdcard
        sudo losetup -d $LOOP
        
        # Compress the image
        zip BarePD-${{ github.ref_name }}-zerow-sdcard.zip $IMG
    
    - name: Create ZIP packages (alternative to images)
      run: |
        # Create RPi 3B package
        mkdir -p pkg-rpi3b
        cp firmware/bootcode.bin pkg-rpi3b/
        cp firmware/start.elf pkg-rpi3b/
        cp firmware/fixup.dat pkg-rpi3b/
        cp firmware/bcm2710-rpi-3-b.dtb pkg-rpi3b/
        cp firmware/bcm2710-rpi-3-b-plus.dtb pkg-rpi3b/
        cp release/rpi3b/kernel8-32.img pkg-rpi3b/
        cp sdcard/config.txt pkg-rpi3b/
        cp sdcard/cmdline.txt pkg-rpi3b/
        cp patches/main.pd pkg-rpi3b/
        cat > pkg-rpi3b/README.txt << 'EOF'
        BarePD for Raspberry Pi 3B/3B+
        ==============================
        
        Copy ALL files to a FAT32 formatted SD card.
        Replace main.pd with your own Pure Data patch.
        
        For I2S audio (PCM5102A DAC):
        - Edit config.txt and uncomment: dtparam=i2s=on
        - Edit cmdline.txt and change: audio=i2s
        
        More info: https://github.com/reverbrick/BarePD
        EOF
        cd pkg-rpi3b && zip -r ../BarePD-${{ github.ref_name }}-rpi3b-files.zip . && cd ..
        
        # Create Zero W package
        mkdir -p pkg-zerow
        cp firmware/bootcode.bin pkg-zerow/
        cp firmware/start.elf pkg-zerow/
        cp firmware/fixup.dat pkg-zerow/
        cp firmware/bcm2708-rpi-zero-w.dtb pkg-zerow/
        cp release/zerow/kernel.img pkg-zerow/
        cp sdcard/config-zerow.txt pkg-zerow/config.txt
        cp sdcard/cmdline.txt pkg-zerow/
        cp patches/main.pd pkg-zerow/
        cat > pkg-zerow/README.txt << 'EOF'
        BarePD for Raspberry Pi Zero W
        ==============================
        
        Copy ALL files to a FAT32 formatted SD card.
        Replace main.pd with your own Pure Data patch.
        
        For I2S audio (PCM5102A DAC):
        - Edit config.txt and uncomment: dtparam=i2s=on
        - Edit cmdline.txt and change: audio=i2s
        
        Note: Zero W is single-core - keep patches simple!
        
        More info: https://github.com/reverbrick/BarePD
        EOF
        cd pkg-zerow && zip -r ../BarePD-${{ github.ref_name }}-zerow-files.zip . && cd ..
        
        # List all packages
        ls -la *.zip
    
    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        name: BarePD ${{ github.ref_name }}
        draft: false
        prerelease: false
        generate_release_notes: true
        body: |
          ## Downloads
          
          ### ðŸ–¼ï¸ SD Card Images (Recommended)
          Flash directly to SD card using [Balena Etcher](https://etcher.balena.io/) or Raspberry Pi Imager:
          - **RPi 3B/3B+**: `BarePD-${{ github.ref_name }}-rpi3b-sdcard.zip`
          - **RPi Zero W**: `BarePD-${{ github.ref_name }}-zerow-sdcard.zip`
          
          ### ðŸ“ File Packages
          Copy contents to a FAT32 SD card:
          - **RPi 3B/3B+**: `BarePD-${{ github.ref_name }}-rpi3b-files.zip`
          - **RPi Zero W**: `BarePD-${{ github.ref_name }}-zerow-files.zip`
          
          ## Quick Start
          1. Download the SD card image for your Pi model
          2. Extract the `.img` file from the ZIP
          3. Flash to SD card with Balena Etcher
          4. Replace `main.pd` with your Pure Data patch
          5. Insert SD card and power on!
          
          ## Audio Output
          - **PWM** (default): 3.5mm headphone jack
          - **I2S**: PCM5102A DAC module (edit config.txt)
          
        files: |
          BarePD-${{ github.ref_name }}-rpi3b-sdcard.zip
          BarePD-${{ github.ref_name }}-zerow-sdcard.zip
          BarePD-${{ github.ref_name }}-rpi3b-files.zip
          BarePD-${{ github.ref_name }}-zerow-files.zip
